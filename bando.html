<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<!-- Thư viện CSS và JavasScript bản đồ Leaflet -->
	<link href ="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css:" rel="stylesheet"/>
	<script src ="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<title>Bản đồ - Bản đồ địa điểm An Giang</title>
</head>

<body>
	<div class="container">
		<div id="navbar"></div>
		<div class="card mt-3">
			<div class="card-header">Bản đồ</div>
			<div class="card-body p-0">
				<div id="bando" style="height:calc(100vh - 160px);border-bottom-left-radius:0.375rem;border-bottom-right-radius:0.375rem"></div>
			</div>
		</div>
		<div id="footer"></div>
	</div>
	<script>
		$(function(){
			$('#navbar').load('inc/navbar.html');
			$('#footer').load('inc/footer.html');
		});
	</script>
	<script type="module" src="inc/config.js"></script>
	<script type="module">
		import { getFirestore, collection, getDocs, getDoc } from 'https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js';
		const db = getFirestore();
		
		async function getDanhSachDiaDiem() {
			const querySnapshot = await getDocs(collection(db, 'diadiem'));
			const promises = querySnapshot.docs.map(doc => getRefData(doc));
			return Promise.all(promises)
		}
		
		async function getRefData(doc) {
			var diaDiem = doc.data();
			diaDiem.id = doc.id;
			var loaiDiaDiem = await getDoc(diaDiem.MaLoai);
			diaDiem.Loai = { ...loaiDiaDiem.data() };
			return diaDiem;
		}
		
		// Khai báo biến toàn cục
		window.getDanhSachDiaDiem = getDanhSachDiaDiem;
	</script>
	<script>
		// Bổ sung code tại đây
		var bando;
		$(function() {
			var tileLayerTheme = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
			var tiles = L.tileLayer(tileLayerTheme, {
			maxZoom: 19,
			attribution: null,
			transparent: true
			});
		    bando = L.map('bando',
			{ 
			center: L.latLng(10.378402685002266, 105.43956802244288),
			zoom: 15,
			layers: [tiles]
			});
			getDanhSachDiaDiem().then(results => {
			results.forEach(d => {
				var image = '';
				if(d.Loai.MaLoai == 1)
					image = 'images/hotel.png';
				else if(d.Loai.MaLoai == 2)
					image = 'images/hospital.png';
				else
					image = 'images/restaurant.png';
				var icon = L.icon({
					iconUrl: image,
					shadowUrl: 'images/marker-shadow.png',
					iconSize: [25, 30],
					iconAnchor: [12, 30],
					shadowSize: [30, 30],
					shadowAnchor: [12, 30],
					popupAnchor: [0, -30]
				});
				var marker = L.marker(new L.LatLng(d.ToaDo.latitude, d.ToaDo.longitude), { icon: icon });
				var popupContent = '<h6 class="mb-1 fw-bold">'.concat(d.TenDiaDiem, '</h6><p class="m-0 text-500">Địa chỉ: ').concat(d.DiaChi, '</p>');
				var popup = L.popup({ minWidth: 180 }).setContent(popupContent);
				marker.bindPopup(popup);
				marker.addTo(bando);
			});
		});
	});
	</script>
</body>

</html>